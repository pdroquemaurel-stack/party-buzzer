<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Party Buzzer 3.0 - Rejoindre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <h1 id="joinTitle">Rejoindre la partie</h1>

    <form id="joinForm" class="card" onsubmit="return false;">
      <div class="field">
        <label>Code de salle</label>
        <input id="room" type="text" inputmode="text" maxlength="8" required />
      </div>
      <div class="field">
        <label>Pseudo</label>
        <input id="pseudo" type="text" maxlength="16" required />
      </div>
      <div class="field">
        <label>Couleur d’équipe</label>
        <div class="team-picker" id="teamPicker">
          <label><input type="radio" name="teamColor" value="#ff5f7e" checked /><span style="background:#ff5f7e"></span> Rose</label>
          <label><input type="radio" name="teamColor" value="#00e5ff" /><span style="background:#00e5ff"></span> Cyan</label>
          <label><input type="radio" name="teamColor" value="#00e676" /><span style="background:#00e676"></span> Vert</label>
          <label><input type="radio" name="teamColor" value="#ffd400" /><span style="background:#ffd400"></span> Jaune</label>
        </div>
      </div>
      <div class="actions">
        <button id="joinBtn">Valider</button>
      </div>
      <small class="hint">Scanne le QR sur l'ecran TV pour pre-remplir la salle.</small>
    </form>

    <section id="waitingPanel" class="card waiting-card" style="display:none;">
      <div class="waiting-badge">Salle en attente</div>
      <p id="waitingText" class="hint">En attente du lancement de la partie par l'admin…</p>
    </section>

    <section id="playerScoreCard" class="card player-score-card" style="display:none;">
      <div class="player-score-label">Votre score</div>
      <div id="playerScoreValue" class="player-score-value">0</div>
    </section>

    <section id="playerIdentityCard" class="card player-identity-card" style="display:none;">
      <div id="joinedAvatar" class="player-identity-avatar">J</div>
      <div class="player-identity-name" id="joinedNameMobile">Joueur</div>
    </section>

    <!-- Buzzer -->
    <section id="buzzerPanel" class="card" style="display:none;">
      <p>Salle: <strong id="joinedRoom"></strong> <span id="joinedTeamDot" class="team-dot"></span></p>
      <button id="buzzBtn" style="font-size:1.4rem;padding:1rem 2rem; width:100%;">BUZZ</button>
      <p id="roundState" class="hint"></p>
      <p><a href="/join">Changer de pseudo/salle</a></p>
    </section>

    <!-- Quiz -->
    <section id="quizPanel" class="card" style="display:none;">
      <p><strong id="quizQ"></strong></p>
      <div class="row" style="display:flex; gap:1rem; flex-wrap:wrap;">
        <button id="btnTrue" style="flex:1; min-width:120px; padding:1rem; font-size:1.1rem;">Vrai</button>
        <button id="btnFalse" style="flex:1; min-width:120px; padding:1rem; font-size:1.1rem;">Faux</button>
      </div>
      <p id="quizInfo" class="hint"></p>
    </section>

    <!-- Guess -->
    <section id="guessPanel" class="card" style="display:none;">
      <p><strong id="guessQ"></strong></p>
      <div class="field">
        <input id="guessRange" type="range" min="0" max="100" value="50" step="1" />
        <div class="row" style="display:flex; justify-content:space-between;">
          <span id="guessMinLabel">0</span>
          <span id="guessVal">50</span>
          <span id="guessMaxLabel">100</span>
        </div>
      </div>
      <p id="guessInfo" class="hint"></p>
    </section>

    <!-- Réponse libre -->
    <section id="freePanel" class="card" style="display:none;">
      <p><strong id="freeQ"></strong></p>
      <div class="field">
        <label>Votre réponse</label>
        <textarea id="freeText" rows="3" maxlength="280" placeholder="Tapez votre réponse ici..." style="width:100%; padding:.8rem; border-radius:12px; border:2px solid rgba(255,255,255,.18); background: rgba(255,255,255,.08); color: var(--text);"></textarea>
      </div>
      <div class="row" style="display:flex; gap:.8rem; align-items:center; flex-wrap:wrap;">
        <button id="freeSendBtn" class="btn-green">Envoyer</button>
        <span id="freeInfo" class="hint"></span>
      </div>
    </section>

    <div id="answerAck" class="answer-ack" style="display:none;"></div>

  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const qs = new URLSearchParams(window.location.search);
    const roomParam = (qs.get('room') || '').toUpperCase();

    const elRoom = document.getElementById('room');
    const elPseudo = document.getElementById('pseudo');
    const elJoinBtn = document.getElementById('joinBtn');
    const elJoinTitle = document.getElementById('joinTitle');
    const elTeamPicker = document.getElementById('teamPicker');
    const elForm = document.getElementById('joinForm');
    const elWaitingPanel = document.getElementById('waitingPanel');
    const elWaitingText = document.getElementById('waitingText');
    const elAnswerAck = document.getElementById('answerAck');
    const elPlayerScoreCard = document.getElementById('playerScoreCard');
    const elPlayerScoreValue = document.getElementById('playerScoreValue');
    const elPlayerIdentityCard = document.getElementById('playerIdentityCard');
    const elJoinedAvatar = document.getElementById('joinedAvatar');
    const elJoinedNameMobile = document.getElementById('joinedNameMobile');

    // Buzzer
    const elBuzzerPanel = document.getElementById('buzzerPanel');
    const elJoinedRoom = document.getElementById('joinedRoom');
    const elJoinedTeamDot = document.getElementById('joinedTeamDot');
    const elBuzz = document.getElementById('buzzBtn');
    const elRoundState = document.getElementById('roundState');

    // Quiz
    const elQuizPanel = document.getElementById('quizPanel');
    const elQuizQ = document.getElementById('quizQ');
    const elBtnTrue = document.getElementById('btnTrue');
    const elBtnFalse = document.getElementById('btnFalse');
    const elQuizInfo = document.getElementById('quizInfo');

    // Guess
    const elGuessPanel = document.getElementById('guessPanel');
    const elGuessQ = document.getElementById('guessQ');
    const elGuessRange = document.getElementById('guessRange');
    const elGuessVal = document.getElementById('guessVal');
    const elGuessMinLabel = document.getElementById('guessMinLabel');
    const elGuessMaxLabel = document.getElementById('guessMaxLabel');
    const elGuessInfo = document.getElementById('guessInfo');

    // Free
    const elFreePanel = document.getElementById('freePanel');
    const elFreeQ = document.getElementById('freeQ');
    const elFreeText = document.getElementById('freeText');
    const elFreeSendBtn = document.getElementById('freeSendBtn');
    const elFreeInfo = document.getElementById('freeInfo');

    if (roomParam) elRoom.value = roomParam;

    let socket = null;
    let currentMode = 'buzzer';
    let cdInt = null;
    let quizAnswered = null;
    let questionActive = { quiz: false, guess: false, free: false, buzzer: false };
    let myPlayerName = '';

    // Guess auto-send
    let myGuess = null;
    let sendDebounce = null;
    let autoFinalTimer = null;
    function debounce(fn, wait) {
      let t = null;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }


    function initials(name) {
      const parts = String(name || '').trim().split(/\s+/);
      const a = (parts[0] || '').charAt(0) || '';
      const b = (parts[1] || '').charAt(0) || '';
      return (a + b).toUpperCase() || (String(name || 'J')[0] || 'J').toUpperCase();
    }

    function setBuzzEnabled(on) { elBuzz.disabled = !on; elBuzz.style.opacity = on ? '1' : '0.6'; }
    function setQuizEnabled(on) {
      elBtnTrue.disabled = !on; elBtnFalse.disabled = !on;
      const op = on ? '1' : '0.6'; elBtnTrue.style.opacity = op; elBtnFalse.style.opacity = op;
    }
    function stopCountdown() { if (cdInt) { clearInterval(cdInt); cdInt = null; } }
    function setModeUI(mode) {
      currentMode = mode;
      const hasActiveQuestion = questionActive[mode] === true;
      elWaitingPanel.style.display = hasActiveQuestion ? 'none' : '';
      elBuzzerPanel.style.display = (mode === 'buzzer' && hasActiveQuestion) ? '' : 'none';
      elQuizPanel.style.display = (mode === 'quiz' && hasActiveQuestion) ? '' : 'none';
      elGuessPanel.style.display = (mode === 'guess' && hasActiveQuestion) ? '' : 'none';
      elFreePanel.style.display = (mode === 'free' && hasActiveQuestion) ? '' : 'none';
      if (!hasActiveQuestion) elWaitingText.textContent = `Mode ${mode} — en attente du lancement Admin…`;
    }

    function markSubmitted(message) {
      elAnswerAck.textContent = message;
      elAnswerAck.style.display = '';
      elAnswerAck.classList.add('show');
    }

    function clearSubmitted() {
      elAnswerAck.textContent = '';
      elAnswerAck.style.display = 'none';
      elAnswerAck.classList.remove('show');
      elBtnTrue.classList.remove('selected');
      elBtnFalse.classList.remove('selected');
    }

    elGuessRange.addEventListener('input', () => {
      elGuessVal.textContent = elGuessRange.value;
      myGuess = parseInt(elGuessRange.value, 10);
      if (!sendDebounce) {
        sendDebounce = debounce(() => {
          if (socket && myGuess !== null) socket.emit('guess:answer', { value: myGuess }, () => {
            markSubmitted(`✅ Réponse prise en compte : ${myGuess}`);
          });
        }, 250);
      }
      sendDebounce();
    });

    elFreeSendBtn.addEventListener('click', () => {
      if (!socket) return;
      const text = elFreeText.value.trim();
      elFreeInfo.textContent = 'Réponse envoyée.';
      markSubmitted('✅ Réponse prise en compte');
      socket.emit('free:answer', { text }, () => {});
    });

    elJoinBtn.addEventListener('click', () => {
      const room = elRoom.value.trim().toUpperCase();
      const pseudo = elPseudo.value.trim();
      const teamColor = (elTeamPicker.querySelector('input[name="teamColor"]:checked') || {}).value || '#ff5f7e';
      if (!room || !pseudo) { alert('Merci de remplir la salle et le pseudo'); return; }

      socket = io();
      socket.emit('player:join', { room, name: pseudo, color: teamColor }, (res) => {
        if (!res || !res.ok) {
          const reason = res && res.error === 'locked' ? 'Partie en cours, réessayez bientôt.' : 'Impossible de rejoindre';
          alert(reason);
          return;
        }

        elJoinedRoom.textContent = room;
        myPlayerName = res.name;
        elJoinedTeamDot.style.background = teamColor;
        elForm.style.display = 'none';
        elWaitingPanel.style.display = '';
        elPlayerScoreCard.style.display = '';
        elPlayerIdentityCard.style.display = '';
        elJoinedNameMobile.textContent = res.name;
        if (elJoinTitle) elJoinTitle.textContent = res.name;
        elJoinedAvatar.textContent = initials(res.name);
        elJoinedAvatar.style.background = teamColor;
        elWaitingText.textContent = "Connecté. En attente du lancement de la partie par l'admin…";
      });

      socket.on('room:players', (players) => {
        const me = (players || []).find((p) => p.name === myPlayerName);
        if (me) elPlayerScoreValue.textContent = String(me.score ?? 0);
      });


      socket.on('room:state', ({ locked }) => {
        if (locked) {
          questionActive = { quiz: false, guess: false, free: false, buzzer: false };
          setModeUI(currentMode);
          elWaitingPanel.style.display = '';
          elWaitingText.textContent = "La salle est fermée par l'admin.";
        }
      });

      // Mode
      socket.on('mode:changed', ({ mode }) => {
        questionActive = { quiz: false, guess: false, free: false, buzzer: false };
        setModeUI(mode);
        clearSubmitted();
        if (mode === 'buzzer') {
          setBuzzEnabled(false);
          elRoundState.textContent = 'Mode Buzzer — en attente du tour...';
        } else if (mode === 'quiz') {
          setQuizEnabled(false);
          elQuizInfo.textContent = 'Mode Quiz — en attente de la question...';
        } else if (mode === 'guess') {
          elGuessInfo.textContent = 'Mode Devine — en attente de la question...';
          myGuess = null; clearTimeout(autoFinalTimer); autoFinalTimer = null;
        } else if (mode === 'free') {
          elFreeText.value = '';
          elFreeInfo.textContent = 'Mode Réponse libre — en attente de la question...';
        }
      });

      // Countdown
      socket.on('countdown:start', ({ seconds }) => {
        stopCountdown();
        let remain = seconds || 3;
        if (currentMode === 'buzzer') {
          setBuzzEnabled(false);
          elRoundState.textContent = 'Début dans ' + remain + '...';
        } else if (currentMode === 'quiz') {
          elQuizInfo.textContent = 'Temps restant: ' + remain + 's';
        } else if (currentMode === 'guess') {
          elGuessInfo.textContent = 'Temps restant: ' + remain + 's';
          clearTimeout(autoFinalTimer);
          autoFinalTimer = setTimeout(() => {
            const v = (myGuess != null) ? myGuess : parseInt(elGuessRange.value, 10);
            if (socket) socket.emit('guess:answer', { value: v }, () => {});
          }, Math.max(0, (seconds * 1000) - 300));
        } else if (currentMode === 'free') {
          elFreeInfo.textContent = 'Temps restant: ' + remain + 's';
          // Envoi auto à ~300ms de la fin
          setTimeout(() => {
            const text = elFreeText.value.trim();
            socket && socket.emit('free:answer', { text }, () => {});
          }, Math.max(0, (seconds * 1000) - 300));
        }
        cdInt = setInterval(() => {
          remain--;
          if (remain > 0) {
            if (currentMode === 'buzzer') elRoundState.textContent = 'Début dans ' + remain + '...';
            else if (currentMode === 'quiz') elQuizInfo.textContent = 'Temps restant: ' + remain + 's';
            else if (currentMode === 'guess') elGuessInfo.textContent = 'Temps restant: ' + remain + 's';
            else if (currentMode === 'free') elFreeInfo.textContent = 'Temps restant: ' + remain + 's';
          } else {
            stopCountdown();
          }
        }, 1000);
      });

      // Buzzer
      socket.on('round:open', () => { stopCountdown(); questionActive.buzzer = true; setModeUI('buzzer'); clearSubmitted(); if (currentMode === 'buzzer') { setBuzzEnabled(true); elRoundState.textContent = 'Tour ouvert !'; } });
      socket.on('round:winner', (data) => { questionActive.buzzer = false; setBuzzEnabled(false); elRoundState.textContent = `Gagnant: ${data.name}`; setModeUI('buzzer'); });
      socket.on('round:reset', () => {
        stopCountdown();
        questionActive = { quiz: false, guess: false, free: false, buzzer: false };
        setModeUI(currentMode);
        if (currentMode === 'buzzer') { setBuzzEnabled(false); elRoundState.textContent = 'Tour réinitialisé. En attente...'; }
        if (currentMode === 'quiz') { setQuizEnabled(false); elQuizInfo.textContent = 'Question réinitialisée. En attente...'; }
        if (currentMode === 'guess') { elGuessInfo.textContent = 'Question réinitialisée. En attente...'; myGuess = null; clearTimeout(autoFinalTimer); autoFinalTimer = null; }
        if (currentMode === 'free') { elFreeInfo.textContent = 'Question réinitialisée. En attente...'; }
      });

      // Quiz
      socket.on('quiz:question', ({ question, seconds }) => { quizAnswered = null; questionActive.quiz = true; setModeUI('quiz'); clearSubmitted(); elQuizQ.textContent = question; setQuizEnabled(true); elQuizInfo.textContent = `Réponds maintenant (${seconds}s)`; });
      socket.on('quiz:result', ({ correct, countTrue, countFalse, total }) => {
        questionActive.quiz = false;
        setQuizEnabled(false);
        const txt = correct ? 'Vrai' : 'Faux';
        const me = quizAnswered == null ? '' : (quizAnswered === correct ? ' — Bravo, +1 !' : ' — Mauvaise réponse.');
        elQuizInfo.textContent = `Bonne réponse: ${txt} — Vrai: ${countTrue}, Faux: ${countFalse}, Total: ${total}${me}`;
      });

      // Guess
      socket.on('guess:start', ({ question, min, max, seconds }) => {
        questionActive.guess = true;
        setModeUI('guess');
        clearSubmitted();
        elGuessQ.textContent = question;
        elGuessRange.min = String(min);
        elGuessRange.max = String(max);
        const mid = Math.round((min + max) / 2);
        elGuessRange.value = String(mid);
        elGuessVal.textContent = String(mid);
        elGuessMinLabel.textContent = String(min);
        elGuessMaxLabel.textContent = String(max);
        elGuessInfo.textContent = `Réponds maintenant (${seconds}s)`;
        myGuess = mid;
        clearTimeout(autoFinalTimer); autoFinalTimer = null;
      });
      socket.on('guess:result', ({ correct, winners }) => {
        questionActive.guess = false;
        setModeUI('guess');
        const me = (myGuess == null) ? '' : (Array.isArray(winners) && winners.includes(myPlayerName) ? ' — Bravo !' : ' — Dommage.');
        elGuessInfo.textContent = `Réponse: ${correct}${me}`;
        clearTimeout(autoFinalTimer); autoFinalTimer = null;
      });

      // Free
      socket.on('free:question', ({ question, seconds }) => {
        questionActive.free = true;
        setModeUI('free');
        clearSubmitted();
        elFreeQ.textContent = question;
        elFreeText.value = '';
        elFreeInfo.textContent = `Réponds maintenant (${seconds}s)`;
      });
      socket.on('free:results', () => {
        questionActive.free = false;
        setModeUI('free');
      });

      socket.on('player:kicked', () => {
        alert("Vous avez été retiré de la salle par l'admin.");
        window.location.href = '/join';
      });

    });

    // Actions
    elBuzz.addEventListener('click', () => { if (!socket) return; setBuzzEnabled(false); socket.emit('buzz:press', () => { markSubmitted('✅ Buzz pris en compte'); }); });
    elBtnTrue.addEventListener('click', () => { if (!socket) return; setQuizEnabled(false); quizAnswered = true; elBtnTrue.classList.add('selected'); elQuizInfo.textContent = 'Réponse envoyée: Vrai'; socket.emit('quiz:answer', { answer: true }, () => { markSubmitted('✅ Réponse Vrai prise en compte'); }); });
    elBtnFalse.addEventListener('click', () => { if (!socket) return; setQuizEnabled(false); quizAnswered = false; elBtnFalse.classList.add('selected'); elQuizInfo.textContent = 'Réponse envoyée: Faux'; socket.emit('quiz:answer', { answer: false }, () => { markSubmitted('✅ Réponse Faux prise en compte'); }); });
  </script>
</body>
</html>
