<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Party Buzzer - Rejoindre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <h1>Rejoindre la partie</h1>

    <form id="joinForm" class="card" onsubmit="return false;">
      <div class="field">
        <label>Code de salle</label>
        <input id="room" type="text" inputmode="text" maxlength="8" required />
      </div>
      <div class="field">
        <label>Pseudo</label>
        <input id="pseudo" type="text" maxlength="16" required />
      </div>
      <div class="actions">
        <button id="joinBtn">Valider</button>
      </div>
      <small class="hint">Scanne le QR sur l'ecran TV pour pre-remplir la salle.</small>
    </form>

    <!-- Buzzer -->
    <section id="buzzerPanel" class="card" style="display:none;">
      <p>Salle: <strong id="joinedRoom"></strong> — Pseudo: <strong id="joinedPseudo"></strong></p>
      <button id="buzzBtn" style="font-size:1.4rem;padding:1rem 2rem; width:100%;">BUZZ</button>
      <p id="roundState" class="hint"></p>
      <p><a href="/join">Changer de pseudo/salle</a></p>
    </section>

    <!-- Quiz -->
    <section id="quizPanel" class="card" style="display:none;">
      <p><strong id="quizQ"></strong></p>
      <div class="row" style="display:flex; gap:1rem; flex-wrap:wrap;">
        <button id="btnTrue" style="flex:1; min-width:120px; padding:1rem; font-size:1.1rem;">Vrai</button>
        <button id="btnFalse" style="flex:1; min-width:120px; padding:1rem; font-size:1.1rem;">Faux</button>
      </div>
      <p id="quizInfo" class="hint"></p>
    </section>

    <!-- Guess -->
    <section id="guessPanel" class="card" style="display:none;">
      <p><strong id="guessQ"></strong></p>
      <div class="field">
        <input id="guessRange" type="range" min="0" max="100" value="50" step="1" />
        <div class="row" style="display:flex; justify-content:space-between;">
          <span id="guessMinLabel">0</span>
          <span id="guessVal">50</span>
          <span id="guessMaxLabel">100</span>
        </div>
      </div>
      <p id="guessInfo" class="hint"></p>
    </section>

    <p><a href="/">Retour a l'accueil</a></p>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const qs = new URLSearchParams(window.location.search);
    const roomParam = (qs.get('room') || '').toUpperCase();

    // Form
    const elRoom = document.getElementById('room');
    const elPseudo = document.getElementById('pseudo');
    const elJoinBtn = document.getElementById('joinBtn');
    const elForm = document.getElementById('joinForm');

    // Buzzer
    const elBuzzerPanel = document.getElementById('buzzerPanel');
    const elJoinedRoom = document.getElementById('joinedRoom');
    const elJoinedPseudo = document.getElementById('joinedPseudo');
    const elBuzz = document.getElementById('buzzBtn');
    const elRoundState = document.getElementById('roundState');

    // Quiz
    const elQuizPanel = document.getElementById('quizPanel');
    const elQuizQ = document.getElementById('quizQ');
    const elBtnTrue = document.getElementById('btnTrue');
    const elBtnFalse = document.getElementById('btnFalse');
    const elQuizInfo = document.getElementById('quizInfo');

    // Guess
    const elGuessPanel = document.getElementById('guessPanel');
    const elGuessQ = document.getElementById('guessQ');
    const elGuessRange = document.getElementById('guessRange');
    const elGuessVal = document.getElementById('guessVal');
    const elGuessMinLabel = document.getElementById('guessMinLabel');
    const elGuessMaxLabel = document.getElementById('guessMaxLabel');
    const elGuessInfo = document.getElementById('guessInfo');

    if (roomParam) elRoom.value = roomParam;

    let socket = null;
    let currentMode = 'buzzer';
    let cdInt = null;
    let quizAnswered = null;

    // Guess auto-send
    let myGuess = null;
    let sendDebounce = null;
    let autoFinalTimer = null;
    function debounce(fn, wait) {
      let t = null;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    function setBuzzEnabled(on) { elBuzz.disabled = !on; elBuzz.style.opacity = on ? '1' : '0.6'; }
    function setQuizEnabled(on) {
      elBtnTrue.disabled = !on; elBtnFalse.disabled = !on;
      const op = on ? '1' : '0.6'; elBtnTrue.style.opacity = op; elBtnFalse.style.opacity = op;
    }
    function stopCountdown() { if (cdInt) { clearInterval(cdInt); cdInt = null; } }
    function setModeUI(mode) {
      currentMode = mode;
      elBuzzerPanel.style.display = (mode === 'buzzer') ? '' : 'none';
      elQuizPanel.style.display = (mode === 'quiz') ? '' : 'none';
      elGuessPanel.style.display = (mode === 'guess') ? '' : 'none';
    }

    elGuessRange.addEventListener('input', () => {
      elGuessVal.textContent = elGuessRange.value;
      myGuess = parseInt(elGuessRange.value, 10);
      // Envoi “throttlé” pour alimenter l'histogramme en direct
      if (!sendDebounce) {
        sendDebounce = debounce(() => {
          if (socket && myGuess !== null) socket.emit('guess:answer', { value: myGuess }, () => {});
        }, 250);
      }
      sendDebounce();
    });

    elJoinBtn.addEventListener('click', () => {
      const room = elRoom.value.trim().toUpperCase();
      const pseudo = elPseudo.value.trim();
      if (!room || !pseudo) { alert('Merci de remplir la salle et le pseudo'); return; }

      socket = io();
      socket.emit('player:join', { room, name: pseudo }, (res) => {
        if (!res || !res.ok) { alert('Impossible de rejoindre'); return; }
        elJoinedRoom.textContent = room;
        elJoinedPseudo.textContent = res.name;
        elForm.style.display = 'none';
        // Le panneau sera affiché selon le mode reçu
      });

      // Mode
      socket.on('mode:changed', ({ mode }) => {
        setModeUI(mode);
        if (mode === 'buzzer') {
          setBuzzEnabled(false);
          elRoundState.textContent = 'Mode Buzzer — en attente du tour...';
        } else if (mode === 'quiz') {
          setQuizEnabled(false);
          elQuizInfo.textContent = 'Mode Quiz — en attente de la question...';
        } else if (mode === 'guess') {
          elGuessInfo.textContent = 'Mode Devine — en attente de la question...';
          myGuess = null;
          clearTimeout(autoFinalTimer); autoFinalTimer = null;
        }
      });

      // Countdown générique
      socket.on('countdown:start', ({ seconds }) => {
        stopCountdown();
        let remain = seconds || 3;
        if (currentMode === 'buzzer') {
          setBuzzEnabled(false);
          elRoundState.textContent = 'Debut dans ' + remain + '...';
        } else if (currentMode === 'quiz') {
          elQuizInfo.textContent = 'Temps restant: ' + remain + 's';
        } else if (currentMode === 'guess') {
          elGuessInfo.textContent = 'Temps restant: ' + remain + 's';
          // Envoi automatique de la dernière valeur juste avant la clôture (sécurité + “dernier réglage”)
          clearTimeout(autoFinalTimer);
          autoFinalTimer = setTimeout(() => {
            const v = (myGuess != null) ? myGuess : parseInt(elGuessRange.value, 10);
            if (socket) socket.emit('guess:answer', { value: v }, () => {});
          }, Math.max(0, (seconds * 1000) - 300));
        }
        cdInt = setInterval(() => {
          remain--;
          if (remain > 0) {
            if (currentMode === 'buzzer') elRoundState.textContent = 'Debut dans ' + remain + '...';
            else if (currentMode === 'quiz') elQuizInfo.textContent = 'Temps restant: ' + remain + 's';
            else if (currentMode === 'guess') elGuessInfo.textContent = 'Temps restant: ' + remain + 's';
          } else {
            stopCountdown();
          }
        }, 1000);
      });

      // Buzzer
      socket.on('round:open', () => { stopCountdown(); if (currentMode === 'buzzer') { setBuzzEnabled(true); elRoundState.textContent = 'Tour ouvert !'; } });
      socket.on('round:winner', (data) => { setBuzzEnabled(false); elRoundState.textContent = `Gagnant: ${data.name}`; });
      socket.on('round:reset', () => {
        stopCountdown();
        if (currentMode === 'buzzer') { setBuzzEnabled(false); elRoundState.textContent = 'Tour reinitialise. En attente...'; }
        if (currentMode === 'quiz') { setQuizEnabled(false); elQuizInfo.textContent = 'Question reinitialisee. En attente...'; }
        if (currentMode === 'guess') { elGuessInfo.textContent = 'Question reinitialisee. En attente...'; myGuess = null; clearTimeout(autoFinalTimer); autoFinalTimer = null; }
      });

      // Quiz
      socket.on('quiz:question', ({ question, seconds }) => { quizAnswered = null; elQuizQ.textContent = question; setQuizEnabled(true); elQuizInfo.textContent = `Reponds maintenant (${seconds}s)`; });
      socket.on('quiz:result', ({ correct, countTrue, countFalse, total }) => {
        setQuizEnabled(false);
        const txt = correct ? 'Vrai' : 'Faux';
        const me = quizAnswered == null ? '' : (quizAnswered === correct ? ' — Bravo, +1 !' : ' — Mauvaise reponse.');
        elQuizInfo.textContent = `Bonne reponse: ${txt} — Vrai: ${countTrue}, Faux: ${countFalse}, Total: ${total}${me}`;
      });

      // Guess
      socket.on('guess:start', ({ question, min, max, seconds }) => {
        elGuessQ.textContent = question;
        elGuessRange.min = String(min);
        elGuessRange.max = String(max);
        const mid = Math.round((min + max) / 2);
        elGuessRange.value = String(mid);
        elGuessVal.textContent = String(mid);
        elGuessMinLabel.textContent = String(min);
        elGuessMaxLabel.textContent = String(max);
        elGuessInfo.textContent = `Réponds maintenant (${seconds}s)`;
        myGuess = mid;
        clearTimeout(autoFinalTimer); autoFinalTimer = null;
      });
      socket.on('guess:result', ({ correct, winners }) => {
        const me = (myGuess == null) ? '' : (Array.isArray(winners) && winners.includes(elJoinedPseudo.textContent) ? ' — Bravo !' : ' — Dommage.');
        elGuessInfo.textContent = `Réponse: ${correct}${me}`;
        clearTimeout(autoFinalTimer); autoFinalTimer = null;
      });
    });

    // Actions
    elBuzz.addEventListener('click', () => { if (!socket) return; setBuzzEnabled(false); socket.emit('buzz:press', () => {}); });
    elBtnTrue.addEventListener('click', () => { if (!socket) return; setQuizEnabled(false); quizAnswered = true; elQuizInfo.textContent = 'Reponse envoyee: Vrai'; socket.emit('quiz:answer', { answer: true }, () => {}); });
    elBtnFalse.addEventListener('click', () => { if (!socket) return; setQuizEnabled(false); quizAnswered = false; elQuizInfo.textContent = 'Reponse envoyee: Faux'; socket.emit('quiz:answer', { answer: false }, () => {}); });
  </script>
</body>
</html>
