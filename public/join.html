<!doctype html> <html lang="fr"> <head> <meta charset="utf-8" /> <title>Party Buzzer - Rejoindre</title> <meta name="viewport" content="width=device-width, initial-scale=1" /> <link rel="stylesheet" href="/style.css" /> </head> <body> <main class="container"> <h1>Rejoindre la partie</h1>

<form id="joinForm" class="card" onsubmit="return false;">
  <div class="field">
    <label>Code de salle</label>
    <input id="room" type="text" inputmode="text" maxlength="8" required />
  </div>
  <div class="field">
    <label>Pseudo</label>
    <input id="pseudo" type="text" maxlength="16" required />
  </div>
  <div class="actions">
    <button id="joinBtn">Valider</button>
  </div>
  <small class="hint">Scanne le QR sur l'ecran TV pour pre-remplir la salle.</small>
</form>

<section id="joined" class="card" style="display:none;">
  <p>Salle: <strong id="joinedRoom"></strong> â€” Pseudo: <strong id="joinedPseudo"></strong></p>
  <button id="buzzBtn" style="font-size:1.4rem;padding:1rem 2rem; width:100%;">BUZZ</button>
  <p id="roundState" class="hint"></p>
  <p><a href="/join">Changer de pseudo/salle</a></p>
</section>

<p><a href="/">Retour a l'accueil</a></p>
</main>

<script src="/socket.io/socket.io.js"></script> <script> const qs = new URLSearchParams(window.location.search); const roomParam = (qs.get('room') || '').toUpperCase();

const elRoom = document.getElementById('room');
const elPseudo = document.getElementById('pseudo');
const elJoinBtn = document.getElementById('joinBtn');
const elForm = document.getElementById('joinForm');
const elJoined = document.getElementById('joined');
const elJoinedRoom = document.getElementById('joinedRoom');
const elJoinedPseudo = document.getElementById('joinedPseudo');
const elBuzz = document.getElementById('buzzBtn');
const elRoundState = document.getElementById('roundState');

if (roomParam) elRoom.value = roomParam;

let socket = null;
let currentRoom = null;

function setBuzzEnabled(on) {
  elBuzz.disabled = !on;
  elBuzz.style.opacity = on ? '1' : '0.6';
}

elJoinBtn.addEventListener('click', () => {
  const room = elRoom.value.trim().toUpperCase();
  const pseudo = elPseudo.value.trim();
  if (!room || !pseudo) { alert('Merci de remplir la salle et le pseudo'); return; }

  socket = io();
  socket.emit('player:join', { room, name: pseudo }, (res) => {
    if (!res || !res.ok) { alert('Impossible de rejoindre'); return; }
    currentRoom = room;
    elJoinedRoom.textContent = room;
    elJoinedPseudo.textContent = res.name; // peut etre pseudo#2 si dupli
    elForm.style.display = 'none';
    elJoined.style.display = '';
    setBuzzEnabled(false);
    elRoundState.textContent = 'En attente du debut de tour...';
  });

  socket.on('round:open', () => {
    setBuzzEnabled(true);
    elRoundState.textContent = 'Tour ouvert ! Appuie pour buzzer.';
  });
  socket.on('round:winner', (data) => {
    setBuzzEnabled(false);
    elRoundState.textContent = `Gagnant: ${data.name}`;
  });
  socket.on('round:reset', () => {
    setBuzzEnabled(false);
    elRoundState.textContent = 'Tour reinitialise. En attente...';
  });
});

elBuzz.addEventListener('click', () => {
  if (!socket) return;
  setBuzzEnabled(false); // evite double clic
  socket.emit('buzz:press', (res) => {
    // rien de special: TV annoncera le gagnant a tout le monde
  });
});
</script> </body> </html>