<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Party Buzzer - TV/Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="tv-body">
  <main class="container tv-layout-3 tight">
    <!-- Bandeau supérieur -->
    <header class="tv-header card">
      <div class="tv-header-left"><h1 style="margin:0;">Party Buzzer</h1></div>
      <div class="tv-header-right">
        <div class="mode-switch">
          <label class="mode-pill"><input type="radio" name="mode" value="buzzer" checked /> Buzzer</label>
          <label class="mode-pill"><input type="radio" name="mode" value="quiz" /> Quiz V/F</label>
          <label class="mode-pill"><input type="radio" name="mode" value="guess" /> Devine</label>
          <label class="mode-pill"><input type="radio" name="mode" value="free" /> Réponse libre</label>
        </div>
      </div>
    </header>

    <!-- Colonne gauche -->
    <aside class="tv-left card">
      <section class="tv-room">
        <div class="row" style="display:flex; align-items:center; justify-content:space-between; gap:.8rem;">
          <div>
            <div class="hint">Code de salle</div>
            <div class="code" id="roomCode"></div>
          </div>
          <div class="tv-qr">
            <a id="qrLink" href="#" target="_blank" rel="noopener" title="Ouvrir la page de join">
              <img id="qr" alt="QR code vers /join" width="120" height="120" />
            </a>
          </div>
        </div>
        <div class="row" style="display:flex; gap:.6rem; flex-wrap:wrap;">
          <button id="regenBtn" title="Regénérer la salle">Nouvelle salle</button>
        </div>
        <p class="row"><a href="/">Retour à l'accueil</a></p>
      </section>

      <section class="tv-status-box">
        <div id="status" class="tv-status"></div>
      </section>
    </aside>

    <!-- Centre: Jeux -->
    <section class="tv-center">
      <!-- Buzzer -->
      <section id="buzzerPanel" class="card">
        <h2>Buzzer</h2>
        <div class="row btn-row">
          <button id="startRoundBtn" class="btn-green">Démarrer le tour</button>
          <button id="resetRoundBtn">Réinitialiser le tour</button>
          <button id="resetScoresBtn" class="btn-cyan">Réinitialiser scores</button>
        </div>
      </section>

      <!-- Quiz -->
      <section id="quizPanel" class="card" style="display:none;">
        <h2>Quiz Vrai/Faux</h2>
        <div class="card soft">
          <h3 style="margin-top:0;">Banque de questions</h3>
          <div class="row btn-row">
            <button id="quizLoadBtn">Charger banque</button>
            <button id="quizRandomBtn" disabled>Question aléatoire</button>
            <span id="quizLoadedInfo" class="hint"></span>
          </div>
        </div>
        <div class="field">
          <label>Question</label>
          <input id="quizQuestion" type="text" placeholder="Ex: Le Soleil est une étoile ?" />
        </div>
        <div class="row btn-row">
          <label><input type="radio" name="quizCorrect" id="quizTrue" value="true" checked /> Vrai</label>
          <label><input type="radio" name="quizCorrect" id="quizFalse" value="false" /> Faux</label>
        </div>
        <div class="field">
          <label>Durée (secondes)</label>
          <input id="quizSeconds" type="number" min="1" max="30" value="5" />
        </div>
        <div class="row btn-row">
          <button id="quizStartBtn" class="btn-green">Poser la question (3-2-1)</button>
          <button id="quizCloseBtn">Clore et corriger</button>
        </div>
        <div id="quizInfo" class="row hint"></div>
      </section>

      <!-- Devine -->
      <section id="guessPanel" class="card" style="display:none;">
        <h2>Devine le nombre</h2>
        <div class="card soft">
          <h3 style="margin-top:0;">Banque</h3>
          <div class="row btn-row">
            <button id="guessLoadBtn">Charger banque</button>
            <button id="guessRandomBtn" disabled>Question aléatoire</button>
            <span id="guessLoadedInfo" class="hint"></span>
          </div>
        </div>
        <div class="field">
          <label>Question</label>
          <input id="guessQuestion" type="text" placeholder="Ex: Combien font 7 x 8 ?" />
        </div>
        <div class="row btn-row" style="flex-wrap:wrap;">
          <div class="field" style="min-width:140px;">
            <label>Réponse correcte</label>
            <input id="guessCorrect" type="number" value="56" />
          </div>
          <div class="field" style="min-width:140px;">
            <label>Min</label>
            <input id="guessMin" type="number" value="0" />
          </div>
          <div class="field" style="min-width:140px;">
            <label>Max</label>
            <input id="guessMax" type="number" value="100" />
          </div>
          <div class="field" style="min-width:140px;">
            <label>Durée (s)</label>
            <input id="guessSeconds" type="number" min="1" max="60" value="8" />
          </div>
        </div>
        <div class="row btn-row">
          <button id="guessStartBtn" class="btn-green">Poser (3-2-1)</button>
          <button id="guessCloseBtn">Clore et corriger</button>
        </div>
        <div id="guessInfo" class="row hint"></div>
        <div class="field">
          <label>Répartition des réponses</label>
          <div id="guessChart" class="chart"></div>
          <div id="guessScale" class="chart-scale"><span>Min</span><span>Max</span></div>
        </div>
      </section>

      <!-- Réponse libre -->
      <section id="freePanel" class="card" style="display:none;">
        <h2>Réponse libre</h2>
        <div class="field">
          <label>Question</label>
          <input id="freeQuestion" type="text" placeholder="Ex: Écris une définition drôle de 'internet'." />
        </div>
        <div class="field" style="max-width:220px;">
          <label>Durée (secondes)</label>
          <input id="freeSeconds" type="number" min="5" max="120" value="30" />
        </div>
        <div class="row btn-row">
          <button id="freeStartBtn" class="btn-green">Poser (3-2-1)</button>
          <button id="freeCloseBtn">Afficher les réponses</button>
        </div>
        <div id="freeInfo" class="row hint"></div>
      </section>
    </section>

    <!-- Droite: Scores -->
    <aside class="tv-right card">
      <section class="tv-scores">
        <h2>Scores</h2>
        <ul id="players" class="score-list"></ul>
      </section>
    </aside>
  </main>

  <!-- Overlays -->
  <div id="overlay" class="overlay" onclick="this.classList.remove('show')">
    <div>
      <div class="label">Gagnant</div>
      <div id="winnerName" class="winner"></div>
      <div class="hint">(cliquer pour fermer)</div>
    </div>
  </div>

  <!-- Countdown -->
  <div id="countdown" class="overlay">
    <div>
      <div class="label">Début dans</div>
      <div id="countNum" class="winner"></div>
    </div>
  </div>

  <!-- Overlay Question (Quiz/Guess/Free) -->
  <div id="quizQOverlay" class="overlay">
    <div>
      <div class="label">Question</div>
      <div id="quizQText" class="question"></div>
      <div id="quizTimer" class="hint" style="margin-top:.8rem;"></div>
      <div id="freeHint" class="hint" style="margin-top: .6rem; display:none;">Écrivez votre réponse sur votre téléphone</div>
    </div>
  </div>

  <!-- Overlay Résultats (Réponse Libre) -->
  <div id="freeResultsOverlay" class="overlay">
    <div style="max-width: 1000px; width: 92vw; text-align: left;">
      <div class="label" style="text-align:center;">Réponses</div>
      <div id="freeResultsList" class="free-list"></div>
      <div style="text-align:center; margin-top: 1rem;">
        <button id="freeResultsCloseBtn">Fermer</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    function generateRoomCode(len) {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out = '';
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }
    function playBeep(freq = 880, durMs = 120) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = freq;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.02);
        o.start();
        setTimeout(() => {
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
          o.stop(ctx.currentTime + 0.12);
        }, durMs);
      } catch {}
    }

    const els = {
      // Salle
      roomCode: document.getElementById('roomCode'),
      qr: document.getElementById('qr'),
      qrLink: document.getElementById('qrLink'),
      regenBtn: document.getElementById('regenBtn'),
      // Scores
      players: document.getElementById('players'),
      // Status + countdown
      status: document.getElementById('status'),
      overlay: document.getElementById('overlay'),
      countdown: document.getElementById('countdown'),
      countNum: document.getElementById('countNum'),
      winnerName: document.getElementById('winnerName'),
      // Mode + panneaux
      modeRadios: document.getElementsByName('mode'),
      buzzerPanel: document.getElementById('buzzerPanel'),
      quizPanel: document.getElementById('quizPanel'),
      guessPanel: document.getElementById('guessPanel'),
      freePanel: document.getElementById('freePanel'),
      // Quiz
      quizLoadBtn: document.getElementById('quizLoadBtn'),
      quizRandomBtn: document.getElementById('quizRandomBtn'),
      quizLoadedInfo: document.getElementById('quizLoadedInfo'),
      quizQuestion: document.getElementById('quizQuestion'),
      quizTrue: document.getElementById('quizTrue'),
      quizFalse: document.getElementById('quizFalse'),
      quizSeconds: document.getElementById('quizSeconds'),
      quizStartBtn: document.getElementById('quizStartBtn'),
      quizCloseBtn: document.getElementById('quizCloseBtn'),
      quizInfo: document.getElementById('quizInfo'),
      // Guess
      guessLoadBtn: document.getElementById('guessLoadBtn'),
      guessRandomBtn: document.getElementById('guessRandomBtn'),
      guessLoadedInfo: document.getElementById('guessLoadedInfo'),
      guessQuestion: document.getElementById('guessQuestion'),
      guessCorrect: document.getElementById('guessCorrect'),
      guessMin: document.getElementById('guessMin'),
      guessMax: document.getElementById('guessMax'),
      guessSeconds: document.getElementById('guessSeconds'),
      guessStartBtn: document.getElementById('guessStartBtn'),
      guessCloseBtn: document.getElementById('guessCloseBtn'),
      guessInfo: document.getElementById('guessInfo'),
      guessChart: document.getElementById('guessChart'),
      guessScale: document.getElementById('guessScale'),
      // Free
      freeQuestion: document.getElementById('freeQuestion'),
      freeSeconds: document.getElementById('freeSeconds'),
      freeStartBtn: document.getElementById('freeStartBtn'),
      freeCloseBtn: document.getElementById('freeCloseBtn'),
      freeInfo: document.getElementById('freeInfo'),
      // Overlays question et free résultats
      quizQOverlay: document.getElementById('quizQOverlay'),
      quizQText: document.getElementById('quizQText'),
      quizTimer: document.getElementById('quizTimer'),
      freeHint: document.getElementById('freeHint'),
      freeResultsOverlay: document.getElementById('freeResultsOverlay'),
      freeResultsList: document.getElementById('freeResultsList'),
      freeResultsCloseBtn: document.getElementById('freeResultsCloseBtn'),

      // Buzzer actions
      startRoundBtn: document.getElementById('startRoundBtn'),
      resetRoundBtn: document.getElementById('resetRoundBtn'),
      resetScoresBtn: document.getElementById('resetScoresBtn')
    };

    const socket = io();
    let room = generateRoomCode(5);

    let cdTimer = null;
    let quizTimer = null;
    let questionBankQuiz = [];
    let questionBankGuess = [];

    const FIXED_BASE = 'https://party-buzzer.onrender.com';
    function buildJoinUrl() { return FIXED_BASE + '/join?room=' + encodeURIComponent(room); }
    function renderInvite() {
      els.roomCode.textContent = room;
      const joinUrl = buildJoinUrl();
      els.qrLink.href = joinUrl;
      const qrApi = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=';
      els.qr.src = qrApi + encodeURIComponent(joinUrl);
    }

    function renderPlayers(list) {
      els.players.innerHTML = '';
      (list || []).forEach(p => {
        const li = document.createElement('li');
        li.className = 'score-item';
        const name = document.createElement('div'); name.className = 'score-name'; name.textContent = p.name;
        const score = document.createElement('div'); score.className = 'score-value'; score.textContent = p.score;
        const controls = document.createElement('div'); controls.className = 'score-controls';
        const btnPlus = document.createElement('button'); btnPlus.className = 'score-btn plus'; btnPlus.textContent = '▲';
        btnPlus.title = 'Ajouter 1 point';
        btnPlus.addEventListener('click', () => { score.textContent = String((parseInt(score.textContent||'0',10)||0)+1); socket.emit('scores:adjust', { name: p.name, delta: +1 }); });
        const btnMinus = document.createElement('button'); btnMinus.className = 'score-btn minus'; btnMinus.textContent = '▼';
        btnMinus.title = 'Retirer 1 point';
        btnMinus.addEventListener('click', () => { score.textContent = String((parseInt(score.textContent||'0',10)||0)-1); socket.emit('scores:adjust', { name: p.name, delta: -1 }); });
        controls.appendChild(btnPlus); controls.appendChild(btnMinus);
        li.appendChild(name); li.appendChild(score); li.appendChild(controls);
        els.players.appendChild(li);
      });
    }

    function setStatus(text) { els.status.textContent = text || ''; }
    function stopCountdownUI() { if (cdTimer) { clearInterval(cdTimer); cdTimer = null; } els.countdown.classList.remove('show'); }
    function startCountdown(sec = 3, onEnd) {
      stopCountdownUI();
      els.countNum.textContent = sec;
      els.countdown.classList.add('show');
      socket.emit('countdown:start', sec);
      playBeep(700, 120);
      let remain = sec;
      cdTimer = setInterval(() => {
        remain--;
        if (remain > 0) { els.countNum.textContent = remain; playBeep(700, 120); }
        else { stopCountdownUI(); playBeep(1200, 200); if (typeof onEnd === 'function') onEnd(); }
      }, 1000);
    }

    function showQuestionOverlay(question, seconds, showFreeHint = false) {
      if (quizTimer) { clearInterval(quizTimer); quizTimer = null; }
      els.quizQText.textContent = question;
      let remain = seconds || 5;
      els.quizTimer.textContent = `Temps restant: ${remain}s`;
      els.freeHint.style.display = showFreeHint ? 'block' : 'none';
      els.quizQOverlay.classList.add('show');
      quizTimer = setInterval(() => {
        remain--;
        if (remain > 0) els.quizTimer.textContent = `Temps restant: ${remain}s`;
        else { clearInterval(quizTimer); quizTimer = null; }
      }, 1000);
    }
    function hideQuestionOverlay() {
      if (quizTimer) { clearInterval(quizTimer); quizTimer = null; }
      els.quizQOverlay.classList.remove('show');
      els.quizTimer.textContent = '';
      els.freeHint.style.display = 'none';
    }

    function setModeUI(mode) {
      els.buzzerPanel.style.display = (mode === 'buzzer') ? '' : 'none';
      els.quizPanel.style.display = (mode === 'quiz') ? '' : 'none';
      els.guessPanel.style.display = (mode === 'guess') ? '' : 'none';
      els.freePanel.style.display = (mode === 'free') ? '' : 'none';
      for (const r of els.modeRadios) r.checked = (r.value === mode);
    }

    function renderGuessChart(prog) {
      els.guessChart.innerHTML = '';
      if (!prog || !Array.isArray(prog.bins) || prog.bins.length === 0) return;
      const maxCount = Math.max(1, ...prog.bins.map(b => b.count));
      prog.bins.forEach(b => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        const h = Math.round((b.count / maxCount) * 100);
        bar.style.height = (h || 2) + '%';
        bar.title = `${b.from}–${b.to}: ${b.count}`;
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = b.count ? b.count : '';
        bar.appendChild(label);
        els.guessChart.appendChild(bar);
      });
      els.guessScale.innerHTML = `<span>${prog.min}</span><span>${prog.max}</span>`;
    }

    window.addEventListener('DOMContentLoaded', function () {
      renderInvite();
      socket.emit('tv:create_room', room);

      // Radios mode -> serveur
      for (const r of els.modeRadios) r.addEventListener('change', () => { if (r.checked) socket.emit('mode:set', { mode: r.value }); });

      // Commun
      socket.on('mode:changed', ({ mode }) => {
        setModeUI(mode);
        els.overlay.classList.remove('show');
        stopCountdownUI();
        hideQuestionOverlay();
        els.quizInfo && (els.quizInfo.textContent = '');
        els.guessInfo && (els.guessInfo.textContent = '');
        els.guessChart && (els.guessChart.innerHTML = '');
        els.freeInfo && (els.freeInfo.textContent = '');
        setStatus(mode === 'buzzer' ? 'Mode Buzzer' : mode === 'quiz' ? 'Mode Quiz' : mode === 'guess' ? 'Mode Devine' : 'Mode Réponse libre');
      });
      socket.on('room:players', renderPlayers);
      socket.on('scores:reset', () => setStatus('Scores réinitialisés'));
      socket.on('round:reset', () => { els.overlay.classList.remove('show'); stopCountdownUI(); hideQuestionOverlay(); setStatus('Tour/Question réinitialisé.'); });

      // Buzzer
      socket.on('round:open', () => { els.overlay.classList.remove('show'); setStatus('Tour ouvert: le plus rapide gagne !'); });
      socket.on('round:winner', (data) => { setStatus(`Gagnant: ${data.name} (+1)`); els.winnerName.textContent = data.name; els.overlay.classList.add('show'); playBeep(1200, 200); });

      // Quiz
      socket.on('quiz:question', ({ question, seconds }) => { setModeUI('quiz'); els.quizInfo.textContent = `Question en cours (${seconds}s): "${question}"`; showQuestionOverlay(question, seconds, false); });
      socket.on('quiz:result', ({ correct, countTrue, countFalse, total }) => { hideQuestionOverlay(); const txt = correct ? 'Vrai' : 'Faux'; els.quizInfo.textContent = `Bonne réponse: ${txt} — Vrai: ${countTrue}, Faux: ${countFalse}, Total: ${total}`; });

      // Guess
      socket.on('guess:start', ({ question, min, max, seconds }) => {
        setModeUI('guess');
        els.guessInfo.textContent = `Question en cours (${seconds}s) — Intervalle: ${min} à ${max}`;
        showQuestionOverlay(question, seconds, false);
        els.guessChart.innerHTML = '';
        els.guessScale.innerHTML = `<span>${min}</span><span>${max}</span>`;
      });
      socket.on('guess:progress', (prog) => { renderGuessChart(prog); });
      socket.on('guess:result', ({ correct, winners, bestDiff, tol }) => {
        hideQuestionOverlay();
        const maxShow = 5;
        const names = winners || [];
        const shown = names.slice(0, maxShow).join(', ');
        const more = names.length > maxShow ? ` (+${names.length - maxShow})` : '';
        const who = names.length ? shown + more : 'Aucun';
        const detail = (bestDiff === null) ? '' : ` — meilleur écart: ${bestDiff}${tol ? `, tolérance≈±${tol}` : ''}`;
        els.guessInfo.textContent = `Réponse: ${correct} — Gagnants: ${who}${detail}`;
      });

      // Free (Réponse libre)
      socket.on('free:question', ({ question, seconds }) => {
        setModeUI('free');
        els.freeInfo.textContent = `Question en cours (${seconds}s)`;
        showQuestionOverlay(question, seconds, true);
      });

      socket.on('free:results', ({ question, items }) => {
        hideQuestionOverlay();
        els.freeResultsList.innerHTML = '';
        const title = document.createElement('div');
        title.className = 'hint';
        title.style.marginBottom = '.6rem';
        title.textContent = `Question: ${question}`;
        els.freeResultsList.appendChild(title);

        (items || []).forEach(item => {
          const row = document.createElement('div');
          row.className = 'free-item' + (item.validated ? ' validated' : '');
          const who = document.createElement('div'); who.className = 'free-who'; who.textContent = item.name;
          const text = document.createElement('div'); text.className = 'free-text'; text.textContent = item.text || '';
          row.appendChild(who); row.appendChild(text);
          row.addEventListener('click', () => {
            socket.emit('free:toggle_validate', { name: item.name });
          });
          els.freeResultsList.appendChild(row);
        });

        els.freeResultsOverlay.classList.add('show');
      });

      socket.on('free:validated', ({ name, validated }) => {
        // Toggle visuel
        const rows = els.freeResultsList.querySelectorAll('.free-item');
        rows.forEach(r => {
          const who = r.querySelector('.free-who');
          if (who && who.textContent === name) {
            r.classList.toggle('validated', !!validated);
          }
        });
      });

      // Salle
      els.regenBtn.addEventListener('click', () => { room = generateRoomCode(5); renderInvite(); socket.emit('tv:create_room', room); });

      // Actions Jeux
      els.startRoundBtn.addEventListener('click', () => startCountdown(3, () => socket.emit('buzz:open')));
      els.resetRoundBtn.addEventListener('click', () => socket.emit('round:reset'));
      els.resetScoresBtn.addEventListener('click', () => socket.emit('scores:reset'));

      // Quiz
      els.quizLoadBtn?.addEventListener('click', async () => {
        try {
          const res = await fetch('/questions.json', { cache: 'no-store' });
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Format invalide');
          questionBankQuiz = data;
          els.quizLoadedInfo.textContent = `${questionBankQuiz.length} question(s) chargée(s).`;
          els.quizRandomBtn.disabled = questionBankQuiz.length === 0;
        } catch { alert('Impossible de charger /questions.json'); questionBankQuiz = []; els.quizLoadedInfo.textContent=''; els.quizRandomBtn.disabled = true; }
      });
      els.quizRandomBtn?.addEventListener('click', () => {
        if (!questionBankQuiz.length) return;
        const item = questionBankQuiz[Math.floor(Math.random() * questionBankQuiz.length)];
        els.quizQuestion.value = item.q || '';
        if (item.a) els.quizTrue.checked = true; else els.quizFalse.checked = true;
      });
      els.quizStartBtn.addEventListener('click', () => {
        const q = els.quizQuestion.value.trim();
        const correct = els.quizTrue.checked;
        const seconds = Math.max(1, Math.min(30, parseInt(els.quizSeconds.value || '5', 10)));
        if (!q) { alert('Entre une question'); return; }
        socket.emit('quiz:start', { question: q, correct, seconds });
        socket.emit('countdown:start', seconds);
        setTimeout(() => socket.emit('quiz:close'), seconds * 1000);
      });
      els.quizCloseBtn.addEventListener('click', () => socket.emit('quiz:close'));

      // Guess
      els.guessLoadBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/guess-questions.json', { cache: 'no-store' });
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Format invalide');
          questionBankGuess = data;
          els.guessLoadedInfo.textContent = `${questionBankGuess.length} question(s) chargée(s).`;
          els.guessRandomBtn.disabled = questionBankGuess.length === 0;
        } catch { alert('Impossible de charger /guess-questions.json'); questionBankGuess = []; els.guessLoadedInfo.textContent=''; els.guessRandomBtn.disabled = true; }
      });
      els.guessRandomBtn.addEventListener('click', () => {
        if (!questionBankGuess.length) return;
        const item = questionBankGuess[Math.floor(Math.random() * questionBankGuess.length)];
        els.guessQuestion.value = item.q || '';
        els.guessCorrect.value = item.c ?? '';
        els.guessMin.value = item.min ?? 0;
        els.guessMax.value = item.max ?? 100;
        els.guessSeconds.value = item.s ?? 8;
      });
      els.guessStartBtn.addEventListener('click', () => {
        const q = els.guessQuestion.value.trim();
        if (!q) { alert('Entre une question'); return; }
        const correct = parseInt(els.guessCorrect.value || '0', 10);
        const min = parseInt(els.guessMin.value || '0', 10);
        const max = parseInt(els.guessMax.value || '100', 10);
        const seconds = Math.max(1, Math.min(60, parseInt(els.guessSeconds.value || '8', 10)));
        socket.emit('guess:start', { question: q, correct, min, max, seconds });
        socket.emit('countdown:start', seconds);
        setTimeout(() => socket.emit('guess:close'), seconds * 1000);
      });
      els.guessCloseBtn.addEventListener('click', () => socket.emit('guess:close'));

      // Free
      els.freeStartBtn.addEventListener('click', () => {
        const q = els.freeQuestion.value.trim();
        const seconds = Math.max(5, Math.min(120, parseInt(els.freeSeconds.value || '30', 10)));
        if (!q) { alert('Entre une question'); return; }
        socket.emit('free:start', { question: q, seconds });
        socket.emit('countdown:start', seconds);
        els.freeInfo.textContent = `Question posée (${seconds}s)`;
        setTimeout(() => socket.emit('free:close'), seconds * 1000);
      });
      els.freeCloseBtn.addEventListener('click', () => socket.emit('free:close'));
      els.freeResultsCloseBtn.addEventListener('click', () => {
        els.freeResultsOverlay.classList.remove('show');
      });
    });
  </script>
</body>
</html>
