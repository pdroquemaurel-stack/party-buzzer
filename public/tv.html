<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Party Buzzer - TV/Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <h1>Ecran TV / Administration</h1>

    <section class="card">
      <h2>Salle</h2>
      <div class="row">
        <div>
          <label>Code de salle:</label>
          <span id="roomCode" class="code"></span>
          <button id="regenBtn">Regenerer</button>
          <button id="copyCodeBtn">Copier le code</button>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Base URL (pour generer le lien/QR):</label>
          <input id="baseUrl" type="text" />
          <small class="hint">Utilise l'URL Render (https://...onrender.com)</small>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Lien d'invitation:</label>
          <a id="joinLink" href="#" target="_blank" rel="noopener"></a>
          <button id="copyLinkBtn">Copier le lien</button>
        </div>
      </div>

      <div class="row qr">
        <img id="qr" alt="QR code vers /join" width="220" height="220" />
      </div>
    </section>

    <section class="card">
      <h2>Mode de jeu</h2>
      <div class="row">
        <label><input type="radio" name="mode" value="buzzer" checked /> Buzzer</label>
        <label style="margin-left:1rem;"><input type="radio" name="mode" value="quiz" /> Quiz Vrai/Faux</label>
      </div>
    </section>

    <section id="buzzerPanel" class="card">
      <h2>Buzzer</h2>
      <div class="row">
        <button id="startRoundBtn">Demarrer le tour</button>
        <button id="resetRoundBtn">Reinitialiser le tour</button>
        <button id="resetScoresBtn">Reinitialiser les scores</button>
      </div>
      <div id="status" class="row"></div>
    </section>

    <section id="quizPanel" class="card" style="display:none;">
      <h2>Quiz Vrai/Faux</h2>

      <div class="card" style="background:#fafafa;">
        <h3 style="margin-top:0;">Banque de questions (facultatif)</h3>
        <div class="row" style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <button id="quizLoadBtn">Charger la banque</button>
          <button id="quizRandomBtn" disabled>Question aléatoire</button>
          <span id="quizLoadedInfo" class="hint"></span>
        </div>
      </div>

      <div class="field">
        <label>Question</label>
        <input id="quizQuestion" type="text" placeholder="Ex: Le Soleil est une étoile ?" />
      </div>
      <div class="row">
        <label><input type="radio" name="quizCorrect" id="quizTrue" value="true" checked /> Vrai</label>
        <label style="margin-left:1rem;"><input type="radio" name="quizCorrect" id="quizFalse" value="false" /> Faux</label>
      </div>
      <div class="field">
        <label>Durée (secondes)</label>
        <input id="quizSeconds" type="number" min="1" max="30" value="5" />
      </div>
      <div class="row">
        <button id="quizStartBtn">Poser la question (3-2-1)</button>
        <button id="quizCloseBtn">Clore et corriger maintenant</button>
      </div>
      <div id="quizInfo" class="row hint"></div>
    </section>

    <section class="card">
      <h2>Joueurs</h2>
      <ul id="players"></ul>
    </section>

    <p><a href="/">Retour a l'accueil</a></p>
  </main>

  <!-- Overlays -->
  <!-- Gagnant (buzzer) -->
  <div id="overlay" class="overlay" onclick="this.classList.remove('show')">
    <div>
      <div class="label">Gagnant</div>
      <div id="winnerName" class="winner"></div>
      <div class="hint">(cliquer pour fermer)</div>
    </div>
  </div>

  <!-- Compte à rebours (buzzer uniquement) -->
  <div id="countdown" class="overlay">
    <div>
      <div class="label">Debut dans</div>
      <div id="countNum" class="winner"></div>
    </div>
  </div>

  <!-- Overlay Question (quiz) -->
  <div id="quizQOverlay" class="overlay">
    <div>
      <div class="label">Question</div>
      <div id="quizQText" class="question"></div>
      <div id="quizTimer" class="hint" style="margin-top:.8rem;"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    function generateRoomCode(len) {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out = '';
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    function playBeep(freq = 880, durMs = 120) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.02);
        o.start();
        setTimeout(() => {
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
          o.stop(ctx.currentTime + 0.12);
        }, durMs);
      } catch {}
    }

    const els = {
      roomCode: document.getElementById('roomCode'),
      baseUrl: document.getElementById('baseUrl'),
      joinLink: document.getElementById('joinLink'),
      qr: document.getElementById('qr'),
      regenBtn: document.getElementById('regenBtn'),
      copyCodeBtn: document.getElementById('copyCodeBtn'),
      copyLinkBtn: document.getElementById('copyLinkBtn'),
      players: document.getElementById('players'),

      // Buzzer
      status: document.getElementById('status'),
      startRoundBtn: document.getElementById('startRoundBtn'),
      resetRoundBtn: document.getElementById('resetRoundBtn'),
      resetScoresBtn: document.getElementById('resetScoresBtn'),
      overlay: document.getElementById('overlay'),
      winnerName: document.getElementById('winnerName'),
      countdown: document.getElementById('countdown'),
      countNum: document.getElementById('countNum'),

      // Mode/Quiz
      modeRadios: document.getElementsByName('mode'),
      buzzerPanel: document.getElementById('buzzerPanel'),
      quizPanel: document.getElementById('quizPanel'),
      quizQuestion: document.getElementById('quizQuestion'),
      quizTrue: document.getElementById('quizTrue'),
      quizFalse: document.getElementById('quizFalse'),
      quizSeconds: document.getElementById('quizSeconds'),
      quizStartBtn: document.getElementById('quizStartBtn'),
      quizCloseBtn: document.getElementById('quizCloseBtn'),
      quizInfo: document.getElementById('quizInfo'),

      // Banque
      quizLoadBtn: document.getElementById('quizLoadBtn'),
      quizRandomBtn: document.getElementById('quizRandomBtn'),
      quizLoadedInfo: document.getElementById('quizLoadedInfo'),

      // Overlay Quiz
      quizQOverlay: document.getElementById('quizQOverlay'),
      quizQText: document.getElementById('quizQText'),
      quizTimer: document.getElementById('quizTimer')
    };

    const socket = io();
    let room = generateRoomCode(5);

    // Timers
    let cdTimer = null;     // pour overlay buzzer
    let quizTimer = null;   // pour timer quiz sur TV

    // Banque
    let questionBank = [];

    function buildJoinUrl() {
      const base = els.baseUrl.value.trim().replace(/\/+$/, '');
      return base + '/join?room=' + encodeURIComponent(room);
    }

    function renderInvite() {
      els.roomCode.textContent = room;
      const joinUrl = buildJoinUrl();
      els.joinLink.textContent = joinUrl || '(renseigne la Base URL)';
      els.joinLink.href = joinUrl || '#';
      const qrApi = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=';
      els.qr.src = joinUrl ? (qrApi + encodeURIComponent(joinUrl)) : '';
    }

    function renderPlayers(list) {
      els.players.innerHTML = '';
      (list || []).forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} — ${p.score} pt${p.score>1?'s':''}${p.connected?' (en ligne)':''}`;
        els.players.appendChild(li);
      });
    }

    function setStatus(text) { els.status.textContent = text || ''; }

    function stopCountdownUI() {
      if (cdTimer) { clearInterval(cdTimer); cdTimer = null; }
      els.countdown.classList.remove('show');
    }

    function startCountdown(sec = 3, onEnd) {
      stopCountdownUI();
      els.countNum.textContent = sec;
      els.countdown.classList.add('show');
      socket.emit('countdown:start', sec);
      playBeep(700, 120);
      let remain = sec;
      cdTimer = setInterval(() => {
        remain--;
        if (remain > 0) {
          els.countNum.textContent = remain;
          playBeep(700, 120);
        } else {
          stopCountdownUI();
          playBeep(1200, 200);
          if (typeof onEnd === 'function') onEnd();
        }
      }, 1000);
    }

    function setModeUI(mode) {
      const isQuiz = mode === 'quiz';
      els.quizPanel.style.display = isQuiz ? '' : 'none';
      els.buzzerPanel.style.display = isQuiz ? 'none' : '';
      for (const r of els.modeRadios) r.checked = (r.value === mode);
    }

    function showQuizOverlay(question, seconds) {
      // Affiche la question et un timer visible
      if (quizTimer) { clearInterval(quizTimer); quizTimer = null; }
      els.quizQText.textContent = question;
      let remain = seconds || 5;
      els.quizTimer.textContent = `Temps restant: ${remain}s`;
      els.quizQOverlay.classList.add('show');
      quizTimer = setInterval(() => {
        remain--;
        if (remain > 0) {
          els.quizTimer.textContent = `Temps restant: ${remain}s`;
        } else {
          clearInterval(quizTimer); quizTimer = null;
        }
      }, 1000);
    }

    function hideQuizOverlay() {
      if (quizTimer) { clearInterval(quizTimer); quizTimer = null; }
      els.quizQOverlay.classList.remove('show');
      els.quizTimer.textContent = '';
    }

    window.addEventListener('DOMContentLoaded', function () {
      els.baseUrl.value = window.location.origin;
      renderInvite();

      socket.emit('tv:create_room', room);

      // Radios mode -> serveur
      for (const r of els.modeRadios) {
        r.addEventListener('change', () => {
          if (r.checked) socket.emit('mode:set', { mode: r.value });
        });
      }

      // Events Socket.IO communs
      socket.on('mode:changed', ({ mode }) => {
        setModeUI(mode);
        els.overlay.classList.remove('show');
        stopCountdownUI();
        hideQuizOverlay();
        els.quizInfo.textContent = '';
        setStatus(mode === 'quiz' ? 'Mode Quiz' : 'Mode Buzzer');
      });
      socket.on('room:players', renderPlayers);
      socket.on('scores:reset', () => setStatus('Scores reinitialises'));

      // Buzzer
      socket.on('round:open', () => {
        els.overlay.classList.remove('show');
        setStatus('Tour ouvert: le plus rapide gagne !');
      });
      socket.on('round:winner', (data) => {
        setStatus(`Gagnant: ${data.name} (+1)`);
        els.winnerName.textContent = data.name;
        els.overlay.classList.add('show');
        playBeep(1200, 200);
      });
      socket.on('round:reset', () => {
        els.overlay.classList.remove('show');
        stopCountdownUI();
        hideQuizOverlay();
        setStatus('Tour/Question reinitialise.');
      });

      // Quiz
      socket.on('quiz:question', ({ question, seconds }) => {
        // Affiche la question en grand le temps de la manche
        setModeUI('quiz');
        els.quizInfo.textContent = `Question en cours (${seconds}s): "${question}"`;
        showQuizOverlay(question, seconds);
      });
      socket.on('quiz:result', ({ correct, countTrue, countFalse, total }) => {
        hideQuizOverlay();
        const correctText = correct ? 'Vrai' : 'Faux';
        els.quizInfo.textContent = `Bonne reponse: ${correctText} — Vrai: ${countTrue}, Faux: ${countFalse}, Total: ${total}`;
      });

      // UI Salle/Invitations
      els.regenBtn.addEventListener('click', () => {
        room = generateRoomCode(5);
        renderInvite();
        socket.emit('tv:create_room', room);
      });
      els.baseUrl.addEventListener('change', renderInvite);
      els.copyCodeBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(room); alert('Code copie'); } catch {}
      });
      els.copyLinkBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(buildJoinUrl()); alert('Lien copie'); } catch {}
      });

      // Buzzer actions
      els.startRoundBtn.addEventListener('click', () => startCountdown(3, () => socket.emit('buzz:open')));
      els.resetRoundBtn.addEventListener('click', () => socket.emit('round:reset'));
      els.resetScoresBtn.addEventListener('click', () => socket.emit('scores:reset'));

      // Banque de questions
      els.quizLoadBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/questions.json', { cache: 'no-store' });
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Format invalide (attendu: tableau)');
          questionBank = data;
          els.quizLoadedInfo.textContent = `${questionBank.length} question(s) chargée(s).`;
          els.quizRandomBtn.disabled = questionBank.length === 0;
        } catch (e) {
          alert('Impossible de charger /questions.json');
          questionBank = [];
          els.quizLoadedInfo.textContent = '';
          els.quizRandomBtn.disabled = true;
        }
      });

      els.quizRandomBtn.addEventListener('click', () => {
        if (!questionBank.length) return;
        const idx = Math.floor(Math.random() * questionBank.length);
        const item = questionBank[idx];
        els.quizQuestion.value = item.q || '';
        if (item.a) { els.quizTrue.checked = true; } else { els.quizFalse.checked = true; }
      });

      // Quiz actions
      els.quizStartBtn.addEventListener('click', () => {
        const q = els.quizQuestion.value.trim();
        const correct = els.quizTrue.checked;
        const seconds = Math.max(1, Math.min(30, parseInt(els.quizSeconds.value || '5', 10)));
        if (!q) { alert('Entre une question'); return; }

        // Démarre officiellement la question
        socket.emit('quiz:start', { question: q, correct, seconds });

        // Lance le chrono pour tous (mobiles) et affiche le timer sur l’overlay Question (via quiz:question + countdown côté clients)
        socket.emit('countdown:start', seconds);

        // Clôture automatique à la fin
        setTimeout(() => socket.emit('quiz:close'), seconds * 1000);
      });

      els.quizCloseBtn.addEventListener('click', () => socket.emit('quiz:close'));
    });
  </script>
</body>
</html>
